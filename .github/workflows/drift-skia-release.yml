name: Drift skia Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  GO_VERSION: "1.25.5"
  NDK_VERSION: "27.1.12297006"

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y ninja-build python3
      - name: Setup Android NDK
        run: |
          SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          yes | "$SDKMANAGER" --install "ndk;$NDK_VERSION" || true
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/$NDK_VERSION" >> "$GITHUB_ENV"
      - name: Fetch Skia
        run: ./scripts/fetch_skia.sh
      - name: Build Skia for Android
        run: ./scripts/build_skia_android.sh
      - name: Package Android artifacts
        run: ./scripts/build_skia_release.sh --android --skip-build
        env:
          DRIFT_VERSION: ${{ inputs.version }}
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: drift-skia-android
          path: |
            dist/drift_skia/*.tar.gz

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install build tools
        run: brew install ninja
      - name: Fetch Skia
        run: ./scripts/fetch_skia.sh
      - name: Build Skia for iOS
        run: ./scripts/build_skia_ios.sh
      - name: Package iOS artifacts
        run: ./scripts/build_skia_release.sh --ios --skip-build
        env:
          DRIFT_VERSION: ${{ inputs.version }}
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: drift-skia-ios
          path: |
            dist/drift_skia/*.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    steps:
      - uses: actions/checkout@v4
      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: drift-skia-android
          path: dist/drift_skia
      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: drift-skia-ios
          path: dist/drift_skia
      - name: Generate manifest with checksums
        id: manifest
        run: |
          set -euo pipefail
          drift_version="${{ inputs.version }}"
          if [[ ! "$drift_version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Invalid version: $drift_version" >&2
            echo "Expected format: vX.Y.Z or vX.Y.Z-suffix" >&2
            exit 1
          fi
          echo "drift_version=$drift_version" >> "$GITHUB_OUTPUT"
          dist_dir="dist/drift_skia"
          android_tar="$dist_dir/drift-$drift_version-android.tar.gz"
          ios_tar="$dist_dir/drift-$drift_version-ios.tar.gz"
          if [[ ! -f "$android_tar" || ! -f "$ios_tar" ]]; then
            echo "Missing Skia tarballs in $dist_dir" >&2
            exit 1
          fi
          android_sha=$(sha256sum "$android_tar" | cut -d ' ' -f1)
          ios_sha=$(sha256sum "$ios_tar" | cut -d ' ' -f1)
          out_dir="$dist_dir/$drift_version"
          mkdir -p "$out_dir"
          cat > "$out_dir/manifest.json" <<EOF
          {
            "drift_version": "${drift_version}",
            "ndk_version": "${{ env.NDK_VERSION }}",
            "android": {
              "tarball": "drift-${drift_version}-android.tar.gz",
              "sha256": "${android_sha}",
              "arches": ["arm64", "arm", "amd64"]
            },
            "ios": {
              "tarball": "drift-${drift_version}-ios.tar.gz",
              "sha256": "${ios_sha}",
              "device_arches": ["arm64"],
              "simulator_arches": ["arm64", "amd64"]
            }
          }
          EOF
      - name: Push Git tag
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${{ inputs.version }}$"; then
            echo "Tag ${{ inputs.version }} already exists on remote (rebuild). Skipping tag creation."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "${{ inputs.version }}" -m "Release ${{ inputs.version }}"
            git push origin "${{ inputs.version }}"
          fi
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          files: |
            dist/drift_skia/*.tar.gz
            dist/drift_skia/*/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Trigger documentation rebuild
        run: gh workflow run docs.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
