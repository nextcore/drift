#!/usr/bin/env bash
# driftw - Drift wrapper for IDE builds
# Locates drift CLI and Go, then runs drift with provided arguments.
#
# Resolution order:
#   1. .drift.env (auto-generated by drift eject/compile/driftw with absolute paths)
#   2. Reconstruct system PATH via path_helper + Go conventions, then self-heal

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Primary: use .drift.env (generated by drift eject, drift compile, or driftw self-heal)
if [[ -f "$SCRIPT_DIR/.drift.env" ]]; then
    source "$SCRIPT_DIR/.drift.env"
    if [[ -x "$DRIFT_BIN" ]]; then
        [[ -x "$GO_BIN" ]] && export PATH="$(dirname "$GO_BIN"):$PATH"
        exec "$DRIFT_BIN" "$@"
    fi
fi

# Reconstruct full PATH for IDE environments (Xcode uses minimal PATH)
# path_helper reads /etc/paths and /etc/paths.d/* (where Homebrew, Go installer, etc. register)
[[ -x /usr/libexec/path_helper ]] && eval "$(/usr/libexec/path_helper -s)"
# Add Go's user-specific binary paths
[[ -n "$GOBIN" && -d "$GOBIN" ]] && export PATH="$GOBIN:$PATH"
[[ -n "$GOPATH" && -d "$GOPATH/bin" ]] && export PATH="$GOPATH/bin:$PATH"
[[ -d "$HOME/go/bin" ]] && export PATH="$HOME/go/bin:$PATH"

# Resolve drift and go from the reconstructed PATH
DRIFT_BIN=$(command -v drift 2>/dev/null || true)
GO_BIN=$(command -v go 2>/dev/null || true)

if [[ -x "$DRIFT_BIN" ]]; then
    # Self-heal: write .drift.env so future IDE builds skip PATH reconstruction
    {
        echo "# Auto-generated by driftw. Do not commit."
        echo "DRIFT_BIN=\"$DRIFT_BIN\""
        [[ -x "$GO_BIN" ]] && echo "GO_BIN=\"$GO_BIN\""
    } > "$SCRIPT_DIR/.drift.env" 2>/dev/null || true
    exec "$DRIFT_BIN" "$@"
fi

echo "Error: drift not found." >&2
echo "Install drift and run 'drift compile $(basename "$(dirname "$SCRIPT_DIR")")' from your terminal," >&2
echo "or install with: go install github.com/go-drift/drift/cmd/drift@latest" >&2
exit 1
