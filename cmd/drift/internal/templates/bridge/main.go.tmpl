package main

// #include <stdint.h>
import "C"

import (
	"sync"

	"github.com/go-drift/drift/pkg/engine"
	"github.com/go-drift/drift/pkg/navigation"
)

var appInitOnce sync.Once

//export DriftAppInit
func DriftAppInit() C.int {
	appInitOnce.Do(main)
	return 0
}

//export DriftPointerEvent
func DriftPointerEvent(pointerID C.int64_t, phase C.int, x C.double, y C.double) {
	if phase < 0 || phase > 3 {
		return
	}
	engine.HandlePointerEvent(engine.PointerEvent{
		PointerID: int64(pointerID),
		X:         float64(x),
		Y:         float64(y),
		Phase:     engine.PointerPhase(phase),
	})
}

//export DriftSetDeviceScale
func DriftSetDeviceScale(scale C.double) {
	engine.SetDeviceScale(float64(scale))
}

//export DriftBackButtonPressed
func DriftBackButtonPressed() C.int {
	if navigation.HandleBackButton() {
		return 1
	}
	return 0
}

//export DriftHitTestPlatformView
func DriftHitTestPlatformView(viewID C.int64_t, x C.double, y C.double) C.int {
	if engine.HitTestPlatformView(int64(viewID), float64(x), float64(y)) {
		return 1 // topmost, allow touch
	}
	return 0 // obscured, block touch
}

//export DriftRequestFrame
func DriftRequestFrame() {
	engine.RequestFrame()
}
